# Приложение для работы с балансом пользователей

Laravel приложение для управления балансом пользователей с поддержкой пополнения, списания и переводов между пользователями.

- ✅ **PHP 8.3+** - Используется PHP 8.3
- ✅ **Laravel 12** - Установлена последняя версия Laravel 12.36.1
- ✅ **PostgreSQL** - База данных PostgreSQL 16
- ✅ **Docker** - Полная поддержка Docker и Docker Compose
- ✅ **API эндпоинты** - Все 4 эндпоинта реализованы
- ✅ **Транзакции** - Все операции выполняются в DB транзакциях с `lockForUpdate()`
- ✅ **Валидация баланса** - Баланс не может быть отрицательным
- ✅ **История операций** - Все транзакции сохраняются со статусами
- ✅ **JSON ответы** - Корректные HTTP коды (200, 404, 409, 422)
- ✅ **Тесты** - Полное покрытие функционала PHPUnit тестами (16 тестов, все проходят)
- ✅ **README** - Подробная документация

## Стэк

- PHP 8.3+
- Laravel 12.36.1
- PostgreSQL 16
- Docker & Docker Compose
- PHPUnit для тестирования

### API Endpoints

#### 1. Пополнение баланса
```bash
POST /api/deposit
Content-Type: application/json

{
  "user_id": 1,
  "amount": 500.00,
  "comment": "Пополнение через карту"
}
```

**Ответ (200):**
```json
{
  "user_id": 1,
  "amount": 500.00,
  "balance": 500.00,
  "comment": "Пополнение через карту"
}
```

#### 2. Списание средств
```bash
POST /api/withdraw
Content-Type: application/json

{
  "user_id": 1,
  "amount": 200.00,
  "comment": "Покупка подписки"
}
```

**Ответ (200):**
```json
{
  "user_id": 1,
  "amount": 200.00,
  "balance": 300.00,
  "comment": "Покупка подписки"
}
```

**Ошибка (409):** Недостаточно средств
```json
{
  "error": "Недостаточно средств на балансе"
}
```

#### 3. Перевод между пользователями
```bash
POST /api/transfer
Content-Type: application/json

{
  "from_user_id": 1,
  "to_user_id": 2,
  "amount": 150.00,
  "comment": "Перевод другу"
}
```

**Ответ (200):**
```json
{
  "from_user_id": 1,
  "to_user_id": 2,
  "amount": 150.00,
  "from_balance": 150.00,
  "to_balance": 150.00,
  "comment": "Перевод другу"
}
```

#### 4. Получение баланса
```bash
GET /api/balance/{user_id}
```

**Ответ (200):**
```json
{
  "user_id": 1,
  "balance": 350.00
}
```

### HTTP коды ответов

- `200` — успешный ответ
- `400` — ошибка валидации входных данных
- `404` — пользователь не найден
- `409` — конфликт (недостаточно средств)
- `422` — ошибка валидации
- `500` — внутренняя ошибка сервера

## Установка и запуск

### Вариант 1: Docker (рекомендуется)

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd testovoe5
```

2. Запустите контейнеры:
```bash
docker-compose up -d
```

3. Приложение будет доступно по адресу: `http://localhost:8000`

### Вариант 2: Локальная установка

1. Установите зависимости:
```bash
composer install
```

2. Скопируйте файл окружения:
```bash
cp .env.example .env
```

3. Настройте подключение к PostgreSQL в `.env`:
```env
DB_CONNECTION=pgsql
DB_HOST=127.0.0.1
DB_PORT=5432
DB_DATABASE=laravel
DB_USERNAME=laravel
DB_PASSWORD=laravel_password
```

4. Сгенерируйте ключ приложения:
```bash
php artisan key:generate
```

5. Запустите миграции:
```bash
php artisan migrate
```

6. (Опционально) Заполните тестовыми данными:
```bash
php artisan db:seed
```

7. Запустите сервер:
```bash
php artisan serve
```

## Структура базы данных

### Таблица `users`
- `id` - ID пользователя
- `name` - Имя пользователя
- `email` - Email (уникальный)
- `password` - Хешированный пароль
- `created_at`, `updated_at` - Временные метки

### Таблица `balances`
- `id` - ID записи
- `user_id` - ID пользователя (внешний ключ, уникальный)
- `balance` - Баланс (decimal 15,2)
- `created_at`, `updated_at` - Временные метки

### Таблица `transactions`
- `id` - ID транзакции
- `user_id` - ID пользователя
- `type` - Тип транзакции (`deposit`, `withdraw`, `transfer_in`, `transfer_out`)
- `amount` - Сумма операции
- `balance_before` - Баланс до операции
- `balance_after` - Баланс после операции
- `related_user_id` - ID связанного пользователя (для переводов)
- `comment` - Комментарий к операции
- `created_at`, `updated_at` - Временные метки

## Тестирование

Проект покрыт тестами. Для запуска тестов:

```bash
php artisan test
```

Или с подробным выводом:
```bash
php artisan test --parallel
```

### Покрытие тестами

Тесты включают проверку:
- ✅ Создание баланса при первом пополнении
- ✅ Пополнение существующего баланса
- ✅ Валидация входных данных
- ✅ Списание средств
- ✅ Проверка недостаточности средств
- ✅ Перевод между пользователями
- ✅ Создание баланса получателя при переводе
- ✅ Невозможность перевода самому себе
- ✅ Получение баланса
- ✅ Обработка несуществующих пользователей
- ✅ Конкурентные операции

## Особенности реализации

### Транзакции
Все денежные операции выполняются в транзакциях базы данных с использованием `lockForUpdate()` для предотвращения race conditions.

### Отрицательный баланс
Баланс не может быть отрицательным. При попытке списания/перевода суммы, превышающей баланс, операция отклоняется с кодом 409.

### История операций
Все операции сохраняются в таблице `transactions` с указанием:
- Баланса до и после операции
- Типа операции
- Связанного пользователя (для переводов)
- Комментария

### Автоматическое создание баланса
Если у пользователя нет записи в таблице `balances`, она автоматически создается при первом пополнении или получении перевода.

## Примеры использования

### 1. Создать пользователей и пополнить баланс
```bash
# Заполнить базу тестовыми пользователями
php artisan db:seed

# Пополнить баланс пользователю с ID 1
curl -X POST http://localhost:8000/api/deposit \
  -H "Content-Type: application/json" \
  -d '{"user_id": 1, "amount": 1000.00, "comment": "Начальное пополнение"}'
```

### 2. Выполнить перевод
```bash
curl -X POST http://localhost:8000/api/transfer \
  -H "Content-Type: application/json" \
  -d '{"from_user_id": 1, "to_user_id": 2, "amount": 150.00, "comment": "Перевод другу"}'
```

### 3. Проверить баланс
```bash
curl http://localhost:8000/api/balance/1
```




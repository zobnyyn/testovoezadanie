# Структура проекта

## Основные компоненты

### Миграции (database/migrations/)
- `0001_01_01_000000_create_users_table.php` - Таблица пользователей
- `2025_10_29_144150_create_balances_table.php` - Таблица балансов
- `2025_10_29_144205_create_transactions_table.php` - Таблица транзакций

### Модели (app/Models/)
- `User.php` - Модель пользователя с отношениями к балансу и транзакциям
- `Balance.php` - Модель баланса пользователя
- `Transaction.php` - Модель транзакции

### Сервисы (app/Services/)
- `BalanceService.php` - Бизнес-логика для операций с балансом
  - `deposit()` - Пополнение баланса
  - `withdraw()` - Списание средств
  - `transfer()` - Перевод между пользователями
  - `getBalance()` - Получение баланса

### Контроллеры (app/Http/Controllers/Api/)
- `BalanceController.php` - API контроллер для работы с балансом
  - Валидация входных данных
  - Обработка ошибок
  - Возврат корректных HTTP кодов

### Маршруты (routes/)
- `api.php` - API маршруты для работы с балансом

### Тесты (tests/Feature/)
- `BalanceTest.php` - Feature тесты для всех операций
  - Тесты пополнения баланса
  - Тесты списания средств
  - Тесты переводов между пользователями
  - Тесты валидации
  - Тесты граничных случаев

### Сидеры (database/seeders/)
- `UserSeeder.php` - Создание тестовых пользователей
- `DatabaseSeeder.php` - Главный сидер

## Docker конфигурация

- `Dockerfile` - Образ приложения с PHP 8.3 и всеми необходимыми расширениями
- `docker-compose.yml` - Оркестрация контейнеров (app + PostgreSQL)
- `.dockerignore` - Исключения для Docker образа

## Конфигурация

- `.env` - Настройки окружения (PostgreSQL connection)
- `phpunit.xml` - Конфигурация тестов (PostgreSQL для тестов)
- `composer.json` - Зависимости PHP

## Архитектура

```
┌─────────────┐
│   Client    │
└──────┬──────┘
       │ HTTP Request
       ▼
┌─────────────────────────┐
│   BalanceController     │
│   (Validation)          │
└──────┬──────────────────┘
       │
       ▼
┌─────────────────────────┐
│   BalanceService        │
│   (Business Logic)      │
└──────┬──────────────────┘
       │
       ▼
┌─────────────────────────┐
│   Models                │
│   (Balance, Transaction)│
└──────┬──────────────────┘
       │ DB Transaction
       ▼
┌─────────────────────────┐
│   PostgreSQL            │
│   (Data Storage)        │
└─────────────────────────┘
```

## Особенности реализации

### 1. Безопасность транзакций
- Использование `DB::transaction()` для атомарности
- `lockForUpdate()` для предотвращения race conditions
- Сортировка ID для избежания deadlock при переводах

### 2. Валидация
- Проверка существования пользователя
- Проверка положительности сумм
- Проверка достаточности средств
- Проверка невозможности перевода самому себе

### 3. История операций
- Все операции записываются в таблицу `transactions`
- Сохранение баланса до и после операции
- Связь с другим пользователем при переводах
- Типы транзакций: `deposit`, `withdraw`, `transfer_in`, `transfer_out`

### 4. Обработка ошибок
- Корректные HTTP коды ответов
- Понятные сообщения об ошибках
- Логирование исключений

### 5. Тестирование
- Feature тесты для всех сценариев
- Использование `RefreshDatabase` для изоляции тестов
- Тесты граничных случаев и ошибок
- 100% покрытие основного функционала

